<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs
        title="__UP_title__"
        title_url="__UP_title_url__"
        directory_title="BaseCamp Viewer"
        description="Displays information from your basecamp projects."
        author="Scott J. Walter"
        author_location="Minneapolis, MN"
        author_email="sjwalter+GoogleGadget@gmail.com"
        author_affiliation="EpicMedia"
        author_photo="http://epicmedia-gadgets.googlecode.com/svn/trunk/photo.png"
        author_link="http://www.epicmedia.com/"
        scrolling="true"
        >
        <Require feature="dynamic-height" />
        <Require feature="setprefs" />
    </ModulePrefs>
    <UserPref name="http_proxy"     display_name="HTTP Proxy"   required="true" />
    <UserPref name="bc_url"         display_name="Feed URL"     required="true" />
    <UserPref name="bc_username"    display_name="Username"     required="true" />
    <UserPref name="bc_password"    display_name="Password"     required="true" />
    <UserPref name="title"                                                      default_value="BaseCamp"                    datatype="hidden" />
    <UserPref name="title_url"                                                  default_value="http://www.basecamphq.com/"  datatype="hidden" />
    <UserPref name="show_dates"     display_name="Show Dates?"                  default_value="false"                       datatype="bool" />
    <UserPref name="num_entries"    display_name="# of Entries:"                default_value="10" />
    <Content type="html"><![CDATA[
        <style>
            #content_div__MODULE_ID__ {
                font-size: 80%;
                margin: 5px;
                background-color: #ffffbf;
            }
        	#content_div__MODULE_ID__ h3 {
        		font-family: arial, sans-serif;
        		font-size: 14px;
        		background-color:#e5ecf9;
        	}
        	#content_div__MODULE_ID__ h3 i {
        		font-family: arial, sans-serif;
        		font-size: 10px;
        	}
        	#content_div__MODULE_ID__ ul,li {
        		font-family: arial, sans-serif;
        		font-size: 12px;
        		list-style-type: none;
        		padding: 0px;
        		margin: 0px;
        	}
        	#content_div__MODULE_ID__ li {
        		margin: 5px 0 0 0;
        	}
        </style>
        <div id="content__MODULE_ID__"><p style='text-align:center;color:#cccccc;'><i>Contacting Basecamp...</i></p></div>
        <script type="text/javascript">
            var gfx_url__MODULE_ID__    = "http://epicmedia-gadgets.googlecode.com/svn/trunk/basecamp/";
            var prefs__MODULE_ID__      = new _IG_Prefs(__MODULE_ID__);
            var entries__MODULE_ID__    = prefs__MODULE_ID__.getInt("num_entries");
            var showdate__MODULE_ID__   = prefs__MODULE_ID__.getBool("show_dates");

            String.prototype.alphaStart__MODULE_ID__  =   function() {
                return /^([a-zA-Z])$/.test(this.substring(0, 1));
            }

            String.prototype.trimAlpha__MODULE_ID__  =   function(len) {
                return this.replace(new RegExp("/^(.{" + len + "})([a-zA-Z]*)(.*)$/"), "$1$3");
            }

            _IG_FetchFeedAsJSON(prefs__MODULE_ID__.getString("http_proxy")
                            +   "?n=" + _esc(prefs__MODULE_ID__.getString("bc_username"))
                            +   "&p=" + _esc(prefs__MODULE_ID__.getString("bc_password"))
                            +   "&u=" + _esc(prefs__MODULE_ID__.getString("bc_url"))
                            ,   function(feed) {
                                    if (feed == null){
                                        _gel("content__MODULE_ID__").innerHTML = "<p style='text-align:center;color:#999999;'><i>There is no data.</i></p>";
                                        return;
                                    }

                                    prefs__MODULE_ID__.set("title", "BaseCamp (" + feed.Title + ")");
                                    prefs__MODULE_ID__.set("title_url", feed.Link);

                                    var html    =   "";

                                    if (feed.Entry) {
                                        for (var i = 0; i < feed.Entry.length; i++) {
                                            var arTitle =   _trim(feed.Entry[i].Title).split(" ");

                                            html    +=  "<li>"
                                                    +       "<img width='10' height='9' "
                                                    +           "src='" + gfx_url__MODULE_ID__ + arTitle[0].toLowerCase() + "_bug.png' "
							                        +           "alt='" + arTitle[0].substr(0, 1).toUpperCase() + ": ' "
							                        +           "title='" + arTitle[0] + "' "
							                        +           "/>"
							                        +       "<a target='_blank' "
							                        +           "href='" + feed.Entry[i].Link + "' "
							                        +           "title='" + arTitle[0] + "' "
							                        +           ">"
							                        ;

                                            for (var j = 2; j < arTitle.length; j++) {
                                                html    +=  (j > 2 ? " " : "") + arTitle[j];
                                            }

                                            html    +=          "</a>";

                                            if (showdate__MODULE_ID__) {
                                                var arDate = _trim((new Date((feed.Entry[i].Date) * 1000)).toLocaleString()).split(" ");

                                                for (var j = 0; j < arDate.length; j++) {
                                                    html    +=  (j > 0 ? " " : "")
                                                            +   (   (arDate[j].alphaStart__MODULE_ID__() && arDate[j].length > 3)
                                                                ?   arDate[j].trimAlpha__MODULE_ID__(3)
                                                                :   arDate[j]
                                                                )
                                                            +   " "
                                                            ;
                                                }
                                            }

                                            html    +=  "</li>";
                                        }
                                    }

                                    _gel("content__MODULE_ID__").innerHTML = "<ul>" + _trim(html) + "</ul>";

                                    _IG_AdjustIFrameHeight();
                                }
                            ,   entries__MODULE_ID__
                            ,   false
                            );

        </script>
    ]]></Content>
</Module>
